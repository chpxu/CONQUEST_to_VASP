from conquest2a.eigenvalue import eigenvalues_processor, k_point_blocks
import pytest
import numpy as np

data_file = "tests/data/test_eigenvalues.dat"
target_bandgap = 0.12999176310841296
proc = eigenvalues_processor(file=data_file)


# Check initialisation of default k_point_blocks
def test_default_kptsblock() -> None:
    block = k_point_blocks(k_index=1, weight=0.00003)
    assert np.array_equal(block.eigenvalues, np.array([0.0, 0, 0, 0, 0, 0, 0, 0, 0, 0]))
    assert np.array_equal(block.eigenvalues_with_fermi, np.array([0.0, 0, 0, 0, 0, 0, 0, 0, 0, 0]))
    assert np.array_equal(block.k_vector, np.array([0.0, 0.0, 0.0]))


def test_file_exists() -> None:
    proc.resolve_path()


def test_num_eigs() -> None:
    assert proc.num_eigenvalues_per_block == 304


def test_fermis() -> None:
    assert proc.fermi_energies[0] == -0.2237425698
    assert proc.fermi_energies[1] == -0.2237425698


def test_num_eigs_in_each_block() -> None:
    for block in proc.eig_blocks:
        assert len(block.eigenvalues) == 304
        assert len(block.eigenvalues_with_fermi) == 304


def test_num_kpts() -> None:
    # Spin up + spin down -> 2x kpts
    assert len(proc.eig_blocks) == 48


def test_bandgap() -> None:
    assert proc.get_bandgap()[-1] == target_bandgap


def test_read_first_header() -> None:
    assert proc.eig_blocks[0].k_index == 1
    assert np.array_equal(proc.eig_blocks[0].k_vector, np.array([0.06988, -0.14267, -0.22642]))
    assert proc.eig_blocks[0].weight == 0.0416666667


def test_read_second_header() -> None:
    assert proc.eig_blocks[1].k_index == 2
    assert np.array_equal(proc.eig_blocks[1].k_vector, np.array([0.06988, -0.14267, -0.07547]))
    assert proc.eig_blocks[1].weight == 0.0416666667


def test_read_spin_down_header() -> None:
    assert proc.eig_blocks[24].k_index == 1
    assert np.array_equal(proc.eig_blocks[24].k_vector, np.array([0.06988, -0.14267, -0.22642]))
    assert proc.eig_blocks[24].weight == 0.0416666667


def test_read_last_header() -> None:
    assert proc.eig_blocks[-1].k_index == 24
    assert np.array_equal(proc.eig_blocks[-1].k_vector, np.array([0.20963, 0.14267, 0.22642]))
    assert proc.eig_blocks[-1].weight == 0.0416666667


def test_read_last_eigenvalues() -> None:
    assert np.array_equal(
        proc.eig_blocks[-1].eigenvalues,
        np.array(
            [
                -3.0570807390,
                -3.0570782341,
                -3.0570747522,
                -3.0570734823,
                -1.9170723409,
                -1.9170672395,
                -1.9170604917,
                -1.9170558363,
                -1.9062590130,
                -1.9062562312,
                -1.9061520733,
                -1.9061493232,
                -1.8878357959,
                -1.8878292114,
                -1.8878249131,
                -1.8878182486,
                -1.0521356607,
                -1.0519433103,
                -1.0517446706,
                -1.0515382801,
                -1.0513200560,
                -1.0512489948,
                -1.0508603909,
                -1.0508296748,
                -1.0501656196,
                -1.0500859145,
                -1.0499912666,
                -1.0499070070,
                -1.0495367082,
                -1.0494352631,
                -1.0488879599,
                -1.0488078473,
                -1.0482093835,
                -1.0480879418,
                -1.0478657241,
                -1.0477694592,
                -0.8807441078,
                -0.8733112546,
                -0.8695608948,
                -0.8645670233,
                -0.8557955302,
                -0.8524906193,
                -0.8490930283,
                -0.8477926820,
                -0.8409036553,
                -0.8389942117,
                -0.8383931540,
                -0.8366039993,
                -0.5914106275,
                -0.5877344948,
                -0.5819454552,
                -0.5756447060,
                -0.4070695110,
                -0.4041565222,
                -0.3948418419,
                -0.3930734448,
                -0.3898347978,
                -0.3850254494,
                -0.3835037867,
                -0.3780513280,
                -0.3705378067,
                -0.3636792353,
                -0.3625210517,
                -0.3583145054,
                -0.3477522198,
                -0.3475378383,
                -0.3407833976,
                -0.3388437228,
                -0.3344793484,
                -0.3315670245,
                -0.3294427920,
                -0.3218807479,
                -0.3182347928,
                -0.3161257234,
                -0.3127707361,
                -0.3120844318,
                -0.3004963203,
                -0.2954638636,
                -0.2914426042,
                -0.2899423345,
                -0.2866619936,
                -0.2853358117,
                -0.2758555463,
                -0.2741093155,
                -0.2626266646,
                -0.2610086640,
                -0.2498218622,
                -0.2465201963,
                -0.1210214944,
                -0.1183069404,
                -0.1082691670,
                -0.1059097019,
                -0.0950590694,
                -0.0910605405,
                -0.0895291871,
                -0.0876948425,
                -0.0824781497,
                -0.0811420797,
                -0.0771019223,
                -0.0770030108,
                -0.0744339964,
                -0.0721255864,
                -0.0708318681,
                -0.0701749997,
                -0.0623932036,
                -0.0585716288,
                -0.0565345340,
                -0.0550309584,
                -0.0522545097,
                -0.0492193894,
                -0.0389608396,
                -0.0368867270,
                -0.0299031956,
                -0.0283192921,
                -0.0260705297,
                -0.0209425869,
                -0.0181218653,
                -0.0171742021,
                -0.0143455706,
                -0.0104442274,
                0.1732922310,
                0.1786548584,
                0.1929407305,
                0.1982275148,
                0.2037163857,
                0.2143291072,
                0.2182327632,
                0.2279541208,
                0.2332360249,
                0.2369252337,
                0.2501115162,
                0.2554067614,
                0.2681547433,
                0.2706083376,
                0.2794553043,
                0.2914455837,
                0.2929087532,
                0.3089992638,
                0.3210698551,
                0.3278396785,
                0.3526024748,
                0.3610369227,
                0.3715673833,
                0.3744322013,
                0.3961875957,
                0.4011639920,
                0.4069066941,
                0.4126360558,
                0.4478023062,
                0.4617281358,
                0.4654800821,
                0.4741888389,
                0.4922449209,
                0.5095977469,
                0.5396880961,
                0.5405348520,
                0.5571334712,
                0.5848620976,
                0.5864987128,
                0.5976479896,
                0.6064207363,
                0.6213227726,
                0.6439225963,
                0.6573693292,
                0.6744012006,
                0.6789468926,
                0.7120717732,
                0.7195439746,
                0.7468540084,
                0.7605283702,
                0.7728573475,
                0.7821269792,
                0.7932754370,
                0.8174785894,
                0.8353715876,
                0.8425714370,
                0.8468199474,
                0.8704692499,
                0.8728364183,
                0.8912783287,
                0.9196660392,
                0.9255701669,
                0.9308833649,
                0.9491275356,
                0.9690645520,
                0.9751098633,
                0.9974827684,
                0.9995020253,
                1.0123904669,
                1.0257876234,
                1.0371579166,
                1.0399600232,
                1.0557908674,
                1.0660448584,
                1.0719365565,
                1.0803887817,
                1.0822643241,
                1.0910905193,
                1.1049208894,
                1.1145897323,
                1.1354534613,
                1.1513116723,
                1.1536221265,
                1.1628346656,
                1.1768777835,
                1.1866150170,
                1.1963188712,
                1.1990400612,
                1.2167363945,
                1.2245604769,
                1.2341404398,
                1.2538027306,
                1.2641237868,
                1.2682794624,
                1.2775396288,
                1.2873045872,
                1.2926610337,
                1.3036060243,
                1.3083151001,
                1.3133252524,
                1.3210964208,
                1.3273438515,
                1.3334002236,
                1.3596074342,
                1.3630465377,
                1.3710136646,
                1.3839624491,
                1.3883767443,
                1.3954506075,
                1.4102086642,
                1.4187028728,
                1.4408894933,
                1.4522116462,
                1.4643942866,
                1.4765963266,
                1.4805462677,
                1.4961673883,
                1.5082807237,
                1.5212631166,
                1.5344583499,
                1.5503925067,
                1.5576024325,
                1.5665157722,
                1.5969569355,
                1.6143896846,
                1.6294694149,
                1.6447429337,
                1.6674537960,
                1.6919965086,
                1.7070406492,
                1.7490520437,
                1.7603768833,
                1.8151968770,
                1.8168320211,
                1.8261035313,
                1.8617717387,
                1.8669541960,
                1.8845140068,
                1.9312874481,
                1.9487560008,
                1.9557861188,
                1.9690820420,
                1.9836125749,
                2.0088748828,
                2.0268733319,
                2.0323713620,
                2.0530937123,
                2.0624721354,
                2.0815252829,
                2.1204806766,
                2.1306324528,
                2.1437082252,
                2.1666473023,
                2.1760489060,
                2.1914283603,
                2.1939538887,
                2.2104082625,
                2.2259817370,
                2.2423247773,
                2.2552242729,
                2.2899957471,
                2.2940524215,
                2.3097473347,
                2.3161794069,
                2.3571934769,
                2.3875312415,
                2.4280669596,
                2.4367989225,
                2.4927635642,
                2.4976463527,
                2.5124153827,
                2.5353479079,
                2.6590486577,
                2.6890935470,
                2.7155894484,
                2.7315399760,
                2.7554504724,
                2.7906880987,
                2.8287263752,
                2.8336648323,
                3.0002319168,
                3.0124005315,
                3.0332891558,
                3.0559965440,
            ]
        ),
    )
